@using _02_Entidades;
@using _03_Data;
@{ BD_NucleosEjecutoresEntities context = new BD_NucleosEjecutoresEntities(); }
@{var MesActual = DateTime.Now;}

<div class="form-group">
    <button class="btn btn-success" onclick="ExportarExcel('tblMatrizReportesPlanosActividadesATM', 'rpt_MatrizResumenActividadesJASS_')"><i class="fa fa-file-excel-o"></i>Exportar</button>
</div>
<div class="form-group">
    <h3>Capacitaciones ATM del Mes de @MesActual.ToString("MMMM")</h3>
</div>
<div class="form-group text-right">
    <h6>Información al 31/12/2022</h6>
</div>
<div class="form-group" style="overflow:auto">
    <table class="table table-bordered-black table-hover" id="tblMatrizReportesPlanosActividadesATM">

        @{
            var objActividades = context.CronogramaActividades.Where(x => x.Tipo == "ATM" && x.Activo == true).ToList();

            if (objActividades != null && objActividades.Count() > 0)
            {
                <tr>
                    <td style="font-weight: bold; text-align: center; vertical-align: middle !important;background-color:rgb(0,112,192);color:#fff;font-size: 16px;border: 0.5px solid #333;" rowspan="3">N°</td>
                    <td style="font-weight: bold; text-align: center; vertical-align: middle !important;background-color:rgb(0,112,192);color:#fff;font-size: 16px;border: 0.5px solid #333;" rowspan="3">Región</td>
                    <td style="font-weight: bold; text-align: center; vertical-align: middle !important;background-color:rgb(0,112,192);color:#fff;font-size: 16px;border: 0.5px solid #333;" rowspan="3">Provincia</td>
                    <td style="font-weight: bold; text-align: center; vertical-align: middle !important;background-color:rgb(0,112,192);color:#fff;font-size: 16px;border: 0.5px solid #333;" rowspan="3">Distrito</td>
                    <td style="font-weight: bold; text-align: center; vertical-align: middle !important;background-color:rgb(0,112,192);color:#fff;font-size: 16px;border: 0.5px solid #333;" rowspan="3">Nro. Total de<br />Mienbros</td>
                    <td style="font-weight: bold; text-align: center; vertical-align: middle !important;background-color:rgb(0,112,192);color:#fff;font-size: 16px;border: 0.5px solid #333;" colspan="2" rowspan="2">Cantidad de<br />Capacitaciones</td>
                    @{
                        var NroMes = objActividades.Select(x => x.NroMes).Distinct().ToList();
                        foreach (var item in NroMes)
                        {
                            var CantidadActividades = objActividades.Where(x => x.NroMes == item).Count() * 4;
                            <td style="word-wrap: break-word;white-space: normal;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;" colspan="@CantidadActividades"> Actividades del Mes - @item</td>
                        }
                    }
                </tr>
                <tr>
                    @{  foreach (var item in objActividades)
                        {
                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;" colspan="4">@item.Actividad</td>
                        }
                    }
                </tr>
                <tr>
                    <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;">Programado del mes de <br />@MesActual.ToString("MMMM")</td>
                    <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;">Ejecutado del mes de <br />@MesActual.ToString("MMMM")</td>
                    @{  foreach (var item in objActividades)
                        {
                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;">Fecha</td>
                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;">Hombres</td>
                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;">Mujeres</td>
                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center;background-color:rgb(0,112,192);color:#fff;">Total</td>
                            
                        }
                    }
                </tr>
                        }

                        var objproy = context.Proyecto.Where(x => x.Cod_subprograma == 133 && x.Estado == 1).Select(m => m.IdUbigeo).Distinct().ToList();
                        if (objproy != null && objproy.Count() > 0)
                        {
                            var Count = 1;
                            foreach (var item in objproy)
                            {
                                var depa = context.Departamento.SingleOrDefault(x => x.cod_depa == item.Substring(0, 2));
                                var prov = context.Provincia.SingleOrDefault(x => x.cod_depa == item.Substring(0, 2) && x.cod_prov == item.Substring(2, 2));
                                var dist = context.Distrito.SingleOrDefault(x => x.cod_depa == item.Substring(0, 2) && x.cod_prov == item.Substring(2, 2) && x.cod_dist == item.Substring(4, 2));

                                var PrimeraATM = context.SeguimientoActividadesATM.FirstOrDefault(x => x.Ubigeo == item && x.Activo == true);
                                
                                <tr>
                                    <td style="width:30px;vertical-align: middle;text-align: center;">@(Count++)</td>
                                    <td style="word-wrap: break-word;white-space: normal;width:150px;vertical-align: middle;">@depa.nom_depa </td>
                                    <td style="word-wrap: break-word;white-space: normal;width:150px;vertical-align: middle;">@prov.nom_prov </td>
                                    <td style="word-wrap: break-word;white-space: normal;width:150px;vertical-align: middle;">@dist.nom_dist </td>
                                    @{
                                        if (PrimeraATM != null)
                                        {
                                            var objDetalleEjecutadas = context.DetalleSeguimientoActividadesATM.Where(x => x.IdSeguimientoActividadesATM == PrimeraATM.IdSeguimientoActividadesATM && x.Fecha.Value.Year == DateTime.Now.Year && x.Fecha.Value.Month == MesActual.Month && x.Activo == true);

                                            <td style="width:30px;vertical-align: middle;text-align: center;">@(PrimeraATM.NroMienbrosHombres + PrimeraATM.NroMienbrosMujeres)</td>


                                            if (objDetalleEjecutadas != null)
                                            {
                                                <td style="width:30px;vertical-align: middle;text-align: center;">0</td>
                                                <td style="width:30px;vertical-align: middle;text-align: center;">@objDetalleEjecutadas.Count()</td>
                                            }
                                            else
                                            {
                                                <td style="width:30px;vertical-align: middle;text-align: center;">0</td>
                                                <td style="width:30px;vertical-align: middle;text-align: center;">0</td>
                                            }


                                            foreach (var i in objActividades)
                                            {
                                                var objDet = context.DetalleSeguimientoActividadesATM.FirstOrDefault(x => x.IdSeguimientoActividadesATM == PrimeraATM.IdSeguimientoActividadesATM && x.IdCronogramaActividades == i.IdCronogramaActividades && x.Activo == true);
                                                if (objDet != null)
                                                {
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center">@Convert.ToDateTime(objDet.Fecha).ToString("dd/MM/yyyy")</td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center">@objDet.NroHombres</td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center">@objDet.NroMujeres</td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center">@objDet.Total</td>
                                            }
                                            else
                                            {
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                                }

                                            }
                                        }
                                        else
                                        {
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                            <td style="word-wrap: break-word;white-space: normal;width:300px;vertical-align: middle;text-align:center"></td>
                                        }
                                    }

                                </tr>
                                            }
                                        }
        }
    </table>
</div>
